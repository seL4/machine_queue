#!/bin/bash

if [ "${SCRIPT_PATH}" == "" ]; then
    echo "This script should not be called directly! Please use mq.sh"
    exit -1
fi

function HaveRebootAndConsole() {
    for host in duvel bob saison
    do
        if [ "$(hostname)" = "${host}" ]; then
            return 0
        fi
    done
    return 1
}

function RebootShutdown() {
    local machine=$1
    if ! HaveRebootAndConsole; then
        ssh -tt -oLogLevel=quiet ${HOST} "stty isig -echoctl -echo; /tftpboot/${machine}/reboot --shutdown"
    else
        "/tftpboot/${machine}/reboot" --shutdown
    fi       
}

function RebootConsoleRunTwoFiles() {
    local completion=$1
    local completion_timeout=$2
    local errortxt=$3
    local output=$4
    local keep_alive=$5
    local kernel=$6
    local rootserver=$7
    local machine=$8

    local logfile=""
    local kernelfile=""
    local rootserverfile=""

    if echo "$kernel" | grep -iq -v "kernel" && echo "$rootserver" | grep -iq "kernel"; then
        echo -e "\e[31mWARNING: Kernel image file must precede rootserver image file!\e[0m"
    fi

    local ka_flag=""
    if $keep_alive ; then
        ka_flag="-a"
    fi

    if ! HaveRebootAndConsole; then
        logfile=$(RemoteCommandOn ${HOST} "mktemp")
        # need to copy remotely
        kernelfile=$(RemoteCommandOn ${HOST} "mktemp")
        rootserverfile=$(RemoteCommandOn ${HOST} "mktemp")
        # Strip trailing \r
        kernelfile=$(echo -n "${kernelfile}" | tr -d '\r')
        rootserverfile=$(echo -n "${rootserverfile}" | tr -d '\r')
        logfile=$(echo -n "${logfile}" | tr -d '\r')
        if ! scp "${kernel}" "${HOST}:${kernelfile}"; then
            echo "Failed to copy kernel image"
            RemoteCommandOn ${HOST} rm "${kernelfile}"
            RemoteCommandOn ${HOST} rm "${rootserverfile}"
            RemoteCommandOn ${HOST} rm "${logfile}"
            return 1
        fi
        if ! scp "${rootserver}" "${HOST}:${rootserverfile}"; then
            echo "Failed to copy rootserver image"
            RemoteCommandOn ${HOST} rm "${kernelfile}"
            RemoteCommandOn ${HOST} rm "${rootserverfile}"
            RemoteCommandOn ${HOST} rm "${logfile}"
            return 1
        fi
        ssh -tt -oLogLevel=quiet ${HOST} "stty isig -echoctl -echo; /tftpboot/${machine}/reboot -l '${logfile}' -c '${completion}' -t '${completion_timeout}' -e '${errortxt}' -k '${kernelfile}' -u '${rootserverfile}' ${ka_flag}"
        local ret=$?
        if [ "${output}" != "" ]; then
            scp "${HOST}:${logfile}" "${output}"
        fi
        RemoteCommandOn ${HOST} rm "${kernelfile}"
        RemoteCommandOn ${HOST} rm "${rootserverfile}"
        RemoteCommandOn ${HOST} rm "${logfile}"
        return $ret
    else
        if [ "${output}" = "" ]; then
            "/tftpboot/${machine}/reboot" -t "${completion_timeout}" -c "${completion}" -e "${errortxt}" -k "${kernel}" -u "${rootserver}" ${ka_flag}
        else
            "/tftpboot/${machine}/reboot" -t "${completion_timeout}" -c "${completion}" -e "${errortxt}" -l "${output}" -k "${kernel}" -u "${rootserver}" ${ka_flag}
        fi
    fi
}

function RebootConsoleRunOneFile() {
    local completion=$1
    local completion_timeout=$2
    local errortxt=$3
    local output=$4
    local keep_alive=$5
    local kernel=$6
    local machine=$7
    
    local logfile=""
    local kernelfile=""

    local ka_flag=""
    if $keep_alive ; then
        ka_flag="-a"
    fi

    if ! HaveRebootAndConsole; then
        logfile=$(RemoteCommandOn ${HOST} "mktemp")
        # need to copy remotely
        kernelfile=$(RemoteCommandOn ${HOST} "mktemp")
        # Strip trailing \r
        kernelfile=$(echo -n "${kernelfile}" | tr -d '\r')
        logfile=$(echo -n "${logfile}" | tr -d '\r')
        if ! scp "${kernel}" "${HOST}:${kernelfile}"; then
            echo "Failed to copy kernel image"
            RemoteCommandOn ${HOST} rm "${kernelfile}"
            RemoteCommandOn ${HOST} rm "${logfile}"
            return 1
        fi
        ssh -tt -oLogLevel=quiet ${HOST} "stty isig -echoctl -echo; /tftpboot/${machine}/reboot -l '${logfile}' -c '${completion}' -t '${completion_timeout}' -e '${errortxt}' -k '${kernelfile}' ${ka_flag}"
        local ret=$?
        if [ "${output}" != "" ]; then
            scp "${HOST}:${logfile}" "${output}"
        fi
        RemoteCommandOn ${HOST} rm "${kernelfile}"
        RemoteCommandOn ${HOST} rm "${logfile}"
        return $ret
    else
        if [ "${output}" = "" ]; then
            "/tftpboot/${machine}/reboot" -t "${completion_timeout}" -c "${completion}" -e "${errortxt}" -k "${kernel}" ${ka_flag}
        else
            "/tftpboot/${machine}/reboot" -t "${completion_timeout}" -c "${completion}" -e "${errortxt}" -l "${output}" -k "${kernel}" ${ka_flag}
        fi
    fi
}
